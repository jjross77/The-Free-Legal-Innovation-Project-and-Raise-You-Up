{% extends 'website_name.html' %}

{% block content %}

<!-- connections table to message -->
<h3 >Connections</h3>
{% for profile_name, profile_image, profile_description, perosnal_profile, iterator1 in profile_messages_table_list %}
 <h3 onclick="upload_projects()" id='{{ profile_name }}'class="text-lg font-semibold">{{ profile_name }}</h3>
 <img id="photo"class="text-lg font-semibold" src='{{ profile_image }}'></img>
 <p onclick="upload_projects()" id='{{ profile_name }}'class="text-lg font-semibold">{{ profile_description }}</p>
{% if perosnal_profile != "None" %}
<button id='delete' value=delete {{ iterator1 }}  <button onclick="modify_info(this.value)"  type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 focus:outline-none">Edit Profile</button>
{% else %}
<button id='delete' value=delete {{ iterator1 }}  <button onclick="modify_info(this.value)"  type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 focus:outline-none">Message</button>
{% endif %}  
{% endfor %} 

<script>
function openForm() {
  document.getElementById("myForm").style.display = "block";
}

function closeForm() {
  document.getElementById("myForm").style.display = "none";
} 
</script> 

<button class="open-button" onclick="openForm()">Add to Project Chat</button>
<div class="invisible" id="myForm">
  <form action="/action_page.php" class="form-container">
    <h1>Login</h1>

    <label for="email"><b>Project Name</b></label>
    <input type="text" placeholder="Enter Email" name="email" required>

    <label for="psw"><b>Username</b></label>
    <input type="password" placeholder="Enter Password" name="psw" required>

    <button type="submit" class="btn">Submit</button>
    <button type="button" class="btn cancel" onclick="closeForm()">Close</button>
  </form>
</div>

<!-- profiles_messaged_tables with group chats -->
<h3 >Messages</h3>
{% for profile_name, profile_image, profile_description, perosnal_profile, iterator1 in profile_messages_table_list %}
 <h3 onclick="upload_projects()" id='{{ profile_name }}'class="text-lg font-semibold">{{ profile_name }}</h3>
 <img id="photo"class="text-lg font-semibold" src='{{ profile_image }}'></img>
 <p onclick="upload_projects()" id='{{ profile_name }}'class="text-lg font-semibold">{{ profile_description }}</p>

{% if perosnal_profile != "None" %}
<button id='delete' value=delete {{ iterator1 }}  <button onclick="modify_info(this.value)"  type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 focus:outline-none">Edit Profile</button>

{% else %}
<button id='delete' value=delete {{ iterator1 }}  <button onclick="modify_info(this.value)"  type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 focus:outline-none">Connect</button>
{% endif %}  
{% endfor %} 



<!-- example chat -->
<h3 >Example chat to be generated dyanmically</h3>
<div class="col-span-1 bg-blue-100 p-4 rounded-lg shadow-md">
      <table class="min-w-full table-auto border-collapse" id="profiles_messaged_table">
        <thead>
          <tr class="bg-gray-200 text-gray-600">
            <th class="px-6 py-3 text-left">Messages</th>
          </tr>
        </thead>
        <tbody>
{% for user_messagining, user_image,message_content,message_date,message_time, iterator1 in test_messages_table_list %}
         <tr class="border-b border-gray-300 hover:bg-gray-100" onclick="show_messages()">
          <td onclick="download_document()"  id='{{ profile_name }}' class="px-6 py-4">{{ profile_name }} </td>
          <td class="px-6 py-4" > <img id="photo"class="text-lg font-semibold" src='{{ profile_image }}'></img> id='{{ iterator1 }}' </td>
          <td onclick="download_document()"  id='{{ profile_name }}' class="px-6 py-4">{{ last_message }} </td>
           <td onclick="download_document()"  id='{{ profile_name }}' class="px-6 py-4">{{ message_date }} </td>
                      <td onclick="download_document()"  id='{{ profile_name }}' class="px-6 py-4">{{ message_time }} </td>


         </tr>
  {% endfor %} 
  

<script>                 
function show_messages(element_id) {
// add preventDefault if necessary here Prevent the form from submitting traditionally
     const celll_element = document.getElementById(element_id);
     const current_task_element = document.getElementById("current_task");
     current_task_element.innerText='Current Task:'+ celll_element.innerText;
     const params = new URLSearchParams({
  key1: element_id,
});
     const url = `/set-current-task/?${params.toString()}`;
          fetch(url, {
             method:'GET',
             headers:{
              'Content-Type':'application/json',
              'X-CSRFToken': getCookie('csrftoken') // CSRF token for protection (if needed)

             }, 
            })
            .then((response) => {
               return response.json(); //converts response to json
            })
            .then((data) => {
            console.log('data:',data)
            //Perform actions with the response data from the view
            // send data to fill different grid values 
            // clear all the tables in the grid
            var relevent_table_names=data[0].relevent_table_names
            var table_object_dict = {};
            var table_objects_array = [];
            
            for (const table_namee of relevent_table_names){
                console.log(table_namee);
                var query_str_list = ["#",table_namee," tbody"]
                var query_str=query_str_list.join('')
                const tableBody = document.querySelector(query_str);
                tableBody.innerHTML = '';
                table_object_dict[table_namee]=[];
                // save table objects
                //table_objects_array.push(tableBody)
                table_object_dict[table_namee].push(tableBody); 
                console.log("object dic");

                console.log(table_object_dict);
                 }              
              //console.log(table_objects_dic);
            fill_grids(data,table_object_dict)// fill all the grids
            
                 });                     
}; 
function open_project_page(element_id) {
// add preventDefault if necessary here Prevent the form from submitting traditionally
     const celll_element = document.getElementById(element_id);
     const current_task_element = document.getElementById("current_task");
     current_task_element.innerText='Current Task:'+ celll_element.innerText;
     const params = new URLSearchParams({
  key1: element_id,
});
     const url = `/set-current-task/?${params.toString()}`;
          fetch(url, {
             method:'GET',
             headers:{
              'Content-Type':'application/json',
              'X-CSRFToken': getCookie('csrftoken') // CSRF token for protection (if needed)

             }, 
            })
            .then((response) => {
               return response.json(); //converts response to json
            })
            .then((data) => {
            console.log('data:',data)
            //Perform actions with the response data from the view
            // send data to fill different grid values 
            // clear all the tables in the grid
            var relevent_table_names=data[0].relevent_table_names
            var table_object_dict = {};
            var table_objects_array = [];
            
            for (const table_namee of relevent_table_names){
                console.log(table_namee);
                var query_str_list = ["#",table_namee," tbody"]
                var query_str=query_str_list.join('')
                const tableBody = document.querySelector(query_str);
                tableBody.innerHTML = '';
                table_object_dict[table_namee]=[];
                // save table objects
                //table_objects_array.push(tableBody)
                table_object_dict[table_namee].push(tableBody); 
                console.log("object dic");

                console.log(table_object_dict);
                 }              
              //console.log(table_objects_dic);
            fill_grids(data,table_object_dict)// fill all the grids
            
                 });                     
};       
   
function fill_project_grids(data,table_object_dict) {
      data.forEach(problem => {
      // get the talbe name
      table_namee=problem.table;
      console.log(table_namee);
      console.log('hi');
      console.log('hi');
      tableBody=table_object_dict[table_namee][0];
      console.log(tableBody);
      const row = document.createElement('tr');
      row.id=problem.iterator2
      row.classList.add('border-b' ,'border-gray-300', 'hover:bg-gray-100');   
      for (const cell_info of problem.cells){
      console.log('cell_info');
      console.log(cell_info.innerText);

      const Cell = document.createElement('td'); 
      Cell.classList.add(cell_info.px,cell_info.py);
      if (cell_info.button!="None"){ 
      
      console.log('this is a button');
      const Button = document.createElement('button'); 
      const divv = document.createElement('div'); 

 
      console.log(cell_info.button[2]);
      Button.classList.add("bg-blue-500","text-white","px-4","py-2","rounded-lg","hover:bg-blue-600","focus:outline-none");
      Button.innerText = cell_info.button[3];
      Button.type=cell_info.button[1];
      Button.value=cell_info.button[4]+problem.iterator2
      console.log("this is the end button");
      console.log(cell_info.button[0]);
      console.log(Button.onclick);
      console.log(Button);
      function modify_info2(){iteratorr=Button.value;
      modify_info(iteratorr)
      console.log('meowwwwwww');}
      Button.addEventListener('click', modify_info2)
    
      //Button.onclick =modify_info;   
      
      Cell.appendChild(Button)
      }
      else {
      console.log('this is not a button');
      Cell.id=problem.iterator;
      Cell.innerText = cell_info.innerText;
      }
      if (cell_info.onclick!="None"){
      
      function set_current_task2(){iteratorrr=problem.iterator;
      set_current_task(iteratorrr)
      console.log('hehehehe');}
      Cell.addEventListener('click', set_current_task2)
      
      //Cell.onclick =set_current_task;
      }
      console.log(cell_info.button[2]);  
      
      if (cell_info.contenteditable!="None"){
      Cell.contentEditable = "true";

      console.log("conent editable"); 
      }             
      row.appendChild(Cell);  
      }
      tableBody.appendChild(row);   
      }); }         
</script>
{% endblock %}
